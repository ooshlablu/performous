name: Build Containers

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  ## Run on a schedule to get monthly updates
  schedule:
    - cron: "* * 28 * *"

  # Run when called from other workflows
  workflow_call:

env:
  REGISTRY: ghcr.io
  REPO_NAME: ${{ github.repository_owner }}

jobs:
  branch_name:
    name: Determine the branch name
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch_name.outputs.branch_name }}
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v3

      - name: Determine the branch name
        id: branch_name
        run: |
          if [ '${{ github.event_name }}' = 'pull_request' ]; then
            DOCKER_BRANCH_NAME="PR-$( echo ${{ github.ref }} | cut -d '/' -f3)"
          else
            DOCKER_BRANCH_NAME="$(git branch --show-current)"
          fi
          echo "branch_name=${DOCKER_BRANCH_NAME}" >> $GITHUB_OUTPUT

  ubuntu:
    runs-on: ubuntu-latest
    needs:
      - branch_name
    strategy:
      matrix:
        os:
          - 20.04
          - 22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to the container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REPO_NAME }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Ubuntu ${{ matrix.os }} Container
        uses: docker/build-push-action@v3
        with:
          context: docker/
          file: ./docker/Dockerfile.ubuntu
          load: true
          tags: ubuntu${{ matrix.os }}-test
          build-args: OS_VERSION=${{ matrix.os }}
                
      - name: Test performous build
        run: |
          docker run --rm ubuntu${{ matrix.os }}-test ./build_performous.sh -g -R
 
      - name: Push container
        uses: docker/build-push-action@v3
        with:
          context: docker/
          push: true
          file: ./docker/Dockerfile.ubuntu
          tags: ${{ env.REGISTRY }}/${{ env.REPO_NAME }}/deps:ubuntu${{ matrix.os }}-${{ needs.branch_name.outputs.branch_name }}
          build-args: OS_VERSION=${{ matrix.os }}

  debian:
    runs-on: ubuntu-latest
    needs:
      - branch_name      
    strategy:
      matrix:
        os:
          - 10 # Buster
          - 11 # Bullseye
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to the container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}                
          username: ${{ env.REPO_NAME }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Debian ${{ matrix.os }} Container
        uses: docker/build-push-action@v3
        with:
          context: docker/
          file: ./docker/Dockerfile.debian
          load: true
          tags: debian${{ matrix.os }}-test
          build-args: OS_VERSION=${{ matrix.os }}
                
      - name: Test performous build
        run: |
          docker run --rm debian${{ matrix.os }}-test ./build_performous.sh -g -R

      - name: Push container
        uses: docker/build-push-action@v3
        with:
          context: docker/
          file: ./docker/Dockerfile.debian
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO_NAME }}/deps:debian${{ matrix.os }}-${{ needs.branch_name.outputs.branch_name }}
          build-args: OS_VERSION=${{ matrix.os }}

  fedora:
    runs-on: ubuntu-latest
    needs:
      - branch_name      
    strategy:
      matrix:
        os:
          - 34
          - 35
          - 36
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to the container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}                
          username: ${{ env.REPO_NAME }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Fedora ${{ matrix.os }} Container
        uses: docker/build-push-action@v3
        with:
          context: docker/
          file: ./docker/Dockerfile.fedora
          load: true
          tags: fedora${{ matrix.os }}-test
          build-args: OS_VERSION=${{ matrix.os }}

      - name: Test performous build
        run: |
          docker run --rm fedora${{ matrix.os }}-test ./build_performous.sh -g -R

      - name: Push container
        uses: docker/build-push-action@v3
        with:
          context: docker/
          file: ./docker/Dockerfile.fedora
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.REPO_NAME }}/deps:fedora${{ matrix.os }}-${{ needs.branch_name.outputs.branch_name }}
          build-args: OS_VERSION=${{ matrix.os }}
